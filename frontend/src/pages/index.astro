---
import { client, getStrapiMedia } from '../lib/strapi';

const storiesRes = await client.collection('stories').find({
  populate: {
    coverImage: true,
    author: true,
  },
  sort: ['createdAt:desc'],
  pagination: { pageSize: 20 },
});

console.log('Fetched stories:', storiesRes);

const stories = storiesRes?.data ?? [];
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Stories — Home</title>

    <style>
      .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
      .card {
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 10px;
        transition: box-shadow .2s ease;
      }
      .card:hover {
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
      }
      img {
        border-radius: 8px;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>

  <body>
    <h1>Latest Stories</h1>

    {stories.length === 0 && <p>No stories yet.</p>}

    <section class="grid">
      {stories.map((story) => {
        // Access fields directly, no `attributes`
        const coverUrl = story.coverImage?.data?.attributes?.url
          ? getStrapiMedia(story.coverImage.data.attributes.url)
          : null;

        const authorName = story.author?.data?.attributes?.name ?? 'Unknown';

        return (
          <article class="card">
            {coverUrl && <img src={coverUrl} alt={story.title} width="100%" />}
            <h2>{story.title}</h2>
            {story.excerpt && <p>{story.excerpt}</p>}
            <p><em>By {authorName}</em></p>
            <a href={`/stories/${story.slug}`}>Read →</a>
          </article>
        );
      })}
    </section>
  </body>
</html>
